---
title: "PLETHEM Design Manual"
author: "Salil N Pendse"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PLETHEM Design Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

This manual documents the structure, function and operation of the Population Lifecourse Exposure to Health Effects Model (PLETHEM) R Package. It provides a detailed description of the design decisions involved in its development and a roadmap for further development of the package.

# Features

PLETHEM is designed to provide a easy to use unified framework for rapid PBPK and high throughput modeling in R. The main features of the package are outlined below.

* Open source R Package
* Implements an 11 compartment diffusion limited PBPK model to support rapid PBPK modeling 
* Implements the complete High-throughput IVIVE model to support *In-vitro* to *In-vivo* extrapolation and steady state calculation
* Qsar model for calculating chemical and tissue specific partition coefficients
* Contains a database of Physiological and chemical parameters for parameterizing models
* Implements lifecourse equations to obtain physiological parameters based on NHANES populations
* Provides dedicated user interfaces for performing 
    + PBPK modeling
    + High-throughput IVIVE
    + Modifying chemical database
    + Adding external obervations 
    + Exporting Parameter sets and models
    
# System Components

## Rapid PBPK Model

PLETHEM implements an 11 compartment diffusion limited model that allows the user to perform PBPK modeling. The model is based on the Induschemfate Model implemented by Jongneelan et al. as a part of the CefiC LRI. Figure 1 shows the schematic of the model as implemented in PLETHEM. No new compartments can be added to the model. However existing compartments can be *turned off*. This causes the blood flow to that compartment and the compartment volume to be added to either the richly or the slowly perfused compartments. 

![rapidPBPK model schematic impletemented within PLETHEM](rapidPBPK.png)

### Exposure
The model allows for three routes of exposure *viz.* __Inhalation__ , __Oral__ and, __Intravenous__ Exposures. Inhalation exposure scenarios can simulate occupational exposures as they allow the user to set a continuous exposures that is active for a few hours a day, repeated for the specified number of days per week. Oral exposure scenarios can be setup as either repeated bolus dose with exposure in __mg/day/kg Body Weight__ or as a continuous exposure in __mg/L__.

### Metabolism
The model allows for metabolic clearance in the Liver and a first order clearance in the blood.  The liver metabolic clearance is modeled as __Michaelis-Menten Kinetics__ of the form $$\frac{d}{dt}Metabolite = \frac{V_{max} * Conc_{parent}}{k_m + Conc_{parent}} $$
Where __V~max~__ is the maximum metabolism rate and __K~m~__ is the michaelis menten constant for the chemical. The user can enter V~max~ directly while setting up the model, or use IVIVE to estimate V~max~ using measured *In-vitro* intrinsic clearance.  Clearance in the blood is simple modeled as a first order rate dependent of the concentration of the parent in the blood.

###Excretion
PLETHEM models __Fecal__ and __Urinary__ routes of excretion. Fecal excretion is modeled as the fraction of compound not absorbed in the gut lumen. Urinary Excretion is modeled as follows: $$\frac{d}{dt}\text{Amount in urine} = GFR*WSOL*(1-FRESRP)*Conc_{parent}$$ Where __GFR__ is the Glomerular Filtration Rate , __WSOL__ is water solubility of the chemical and __FRESRP__ is the fraction of chemical resporped by the kidney


### Physiology
Physiological parameters for each of the compartments can be manually entered by the user. They can also be calculated on the basis of Lifecourse equations developed by Scitovation. Similarly the partition coefficient for each tissue can be calculated using the QSAR model included. 

### Population Variability
Population variability can be examined by using Monte Carlo analysis to run the model. Each physiological and chemical parameter in the model can defined as either a logNormal or a Normal distribution. The model is then run multiple times with a distinct parameter set. The value of each parameter is drawn from its defined distribution.

## High Throughput IVIVE (HT-IVIVE) Model

The HT-IVIVE model is used to extrapolate observed *in-vitro* concentration to steady state *in-vivo* blood concentration and equivalent dose, using measured *in-vitro* intrinsic clearance. The table below lists the different options to perform HT-IVIVE with. Some options are mutually exclusive.

| Options | Types |
|:-----------------------------:|:--------------------------------------------------------------:|
|HT-IVIVE Type| Oral Exposure Non-Volatile Chemicals, Oral Exposure Volatile Chemicals, Inhalation Exposure Volatile Chemicals|
|Intrinsic Clearance| Hepatic Clearance, Renal Clearance, Blood Clearance|
|Hepatic Clearance Scaling | Rowland Equation, Restrictive Clearance, Non-restrictive Clearance|
|Hepatic Clearance Measuring Systems| Human Hepatocytes, Sub Cellular Fraction, S9 Fraction, Recombinant Enzymes |

### Renal Clearance
The steady state renal clearance is calculated as the product of Glomerular Filtration Rate and Fraction of chemical unbound in blood. 

### Blood Clearance
The steady state blood clearance is calculated by using the measured intrinsic clearance provided by the user
$$ \text{Clb}_{intrinsic} = \text{Measured in-vitro intrinsic clearance} \times \text{Blood Volume} $$ 
This gives us the intrinsic scaled clearance in the blood. We can then get the total blood clearance, $\text{Clb}$, using the equation below
$$\text{Clb} = \frac{\text{Qc}\times\text{Clb}_\text{intrinsic}}{(\text{Qc} + \text{Clb}_\text{intrinsic})}$$ Where $\text{Qc}$ is the cardiac output in $\ ^{L}/_{h}$

###Hepatic Clearance
*In-vitro* intrinsic clearance ($Cl_{instrinsic\ vitro}$) measured by different measurement systems state in the table above can be used to perform IVIVE. The measured value is scaled to an *in-vivo* intrinsic clearance, $Cl_{intrinsic}$. The clearance measured in __Whole Hepatocytes__, __Subcellular Fraction__ or, __S9 Fraction__ is converted to and *in-vivo* intrinsic clearance using a formula of the type
$$ Cl_{instrinsic} = Cl_{intrinsic\ vitro} \times (\text{metabolising protein/ g Liver}) \times \text{Liver weight}$$ 

For intrinsic *in vitro* clearance measured using recombinant enzymes, we use the enzyme abundance and ISEF information stored in PLETHEM databases to calculate a total *in-vivo* intrinsic clearance across all the measured enzyme activities.


### Hepatic Clearance Scaling
The *in-vivo* intrinsic clearance calculated by using measured *in-vitro* intrinsic clearance is then scaled to whole hepatic clearance by using one of the following three scaling equations, depending on how the compound is bound in the blood ($\text{fub}$). This scaling only applies to non-volatile chemicals following oral exposure. For all other exposure and chemical types we use the intrinsic clearance calculated in the previous step

#### Rowland Equation
The binding of the compound in the blood is assumed to limit the metabolism of the compound in the liver. This leads us to use to use the following form to calculate liver metabolism.

$$\text{Clh} = \frac{\text{Q}_{\text{liver}}\times\text{fub}\times\text{Cl}_{\text{intrinsic}}}{({\text{Q}_{\text{liver}}+\text{fub}\times\text{Cl}_{\text{intrinsic}}})} $$ 


#### Restrictive Clearance Equation
The definition above overestimates clearance if the uptake of compound in the liver is limited by the rate of dissociation of the compound from its binding proteins. In that case we need to include the assumption that no dissociation of bound compounds is happening while the blood is going through the liver. This restrictive clearance is captured by the following equation. Note the lack of $\text{fub}$ in the denominator.

$$\text{Clh} = \frac{\text{Q}_{\text{liver}}\times\text{fub}\times\text{Cl}_{\text{intrinsic}}}{({\text{Q}_{\text{liver}}+\text{Cl}_{\text{intrinsic}}})} $$ 

#### Non-restrictive Clearance Equation
If the dissociation from protein binding and hepatocellular uptake are very fast compared to metabolic clearance, then practically the protein binding has no effect on metabolism. This leads us to the a clearance equation independent of $\text{fub}$
$$\text{Clh} = \frac{\text{Q}_{\text{liver}}\times\text{Cl}_{\text{intrinsic}}}{({\text{Q}_{\text{liver}}+\text{Cl}_{\text{intrinsic}}})} $$ 

### Blood Steady State Concentration

The calculated *in-vivo* clearances can be used to measure the steady state blood concentration ($C_{ss}$) for a standard dose rate based on the exposure type. The current HT-IVIVE model can account for __Oral__ exposures of __volatile__ and __non-volatile__ chemicals and __Inhalation__ exposure of __volatile__ chemicals. 

#### $C_{ss}$ for Oral Exposures

The standard dose for Oral exposure is assumed to be $1\ ^{\text{mg}}/_{\text{kg}\times\text{day}}$. Based on this standard exposure($Dose_{std}$), we can calculate a daily dose rate as $\text{Dose Rate} = \text{Dose}_{std}\times\ \text{BW}\ /\ 24$ The $C_{ss}$ in blood can be calulated as follows for non-volatile chemicals.  
$$\text{C}_{ss} = \frac{\text{Dose Rate}}{(\text{Clh}+\text{CLb}+\text{Clren})}$$
As mentioned above, we consider the caculated intrinsic clearance value $\text{Cl}_{intrinsic}$ to calulate the $C_{ss}$ for volatile chemicals

$$\text{C}_{ss} = \frac{\text{Dose Rate}\times\text{Q}_{\text{liver}}}{[(\text{Q}_{\text{liver}}+\text{Cl}_{intrinsic}) \times (\text{Q}_{\text{liver}} + {\ ^{\text{Q}_{\text{alv}}}}/_{P_{blood}})]}$$  

Where $\text{Q}_{\text{alv}}$ is the alveolar ventilation rate and $P_{blood}$ is the blood-air partition coefficient

#### $C_{ss}$ for Inhalation Exposures
For inhalation exposure the standard dose ($Dose_{std}$) is assumed to be 1 ppm. This dose is used to calculate the $C_{ss}$ in the blood for volatile chemicals following inhalation exposure thought the following equation
$$C_{ss} = \frac{Dose_{std}}{[(^1/_{P_{blood}})\ + (\ ^{Q_{liver}}/_{Q_{alv}}\ )\times\ ^{Cl_{intrinsic}}/_{(\ Q_{liver}\ +\ Cl_{intrinsic})}]} $$

### Equivalent Dose Calculation
Finally the HT-IVIVE module can also be used to calculate an equivalent __Oral__ or __Inhalation__ dose for a *in-vitro* Point of Departure (POD). This can be used with calculated exposure metrics to obtain a Margin of Exposure (MoE) for different chemicals. Assuming the an *in-vitro* point of departure, $POD_{ivt}$, measured in $\mu M$, we can calculate an equivalent dose in $\text{mg}\ /\ (\text{kg}\times\text{day})\ $ or ppm using the following equation:

$$ Dose_{equivalent} = Dose_{std} \times \frac{\ ^{POD_{ivt}\times MW}/_{1000}}{C_{ss}}$$
Where $MW$ is the molecular weight of the chemical and $C_{ss}$ is the steady state concentration in the blood calculated previously

## Databases
To hold all the information needed to run PLETHEM and user specific data to be used with the PLETHEM software, the package implements includes three sqlite databases. The __master__ database is static and is not editable by the user. This database gets updated whenever a new version of the package is released. The other two database, viz the __project__ and __chemical__ databases are modified by the user as they use the package.

### Master Database
The master database consists holds static information that is needed for the models and user interfaces to run effectively It also contains example dataset of chemicals, physiological parameters and observation datasets needed to run the example vignettes.

### Project Database
The project database hold all the information related to project the user is currently working on. Projects are the highest level of organization within PLETHEM. Each project is tied to one the models described above and can hold multiple chemical, exposure scenario and simulations. While the user is working on a project, the project database provides the UI with all the necessary information. The user can then save the project externally as plethem project file. This saves a version of the project database on the local disk. The project database in the installed package is then cleaned and can be used for running a completely new independent project.

### Chemical Database
The master database comes prepopulated with relatively large chemical dataset. However the user may need to add more chemicals or modify information regarding existing chemicals in the dataset. To allow the user to do this and keep the information persistent across multiple R sessions, PLETHEM uses a chemical database on the users local disk to store all the information. When PLETHEM is first loaded, the user is given the option of either linking the existing chemical database to PLETHEM or creating a entirely new one. If a new database is created, it is initialized with all the tables needed to hold the different chemical information needed by PLETHEM models.

## User Interface.

Users interact with the package primarily through the interface for different models and workflows. As new models are added to the package, they will get their own interfaces that can store, read and modify information stored in any of the PLETHEM databases. Additionally there are a couple of utility interfaces for modifying the user specific chemical table, for adding observation datasets to projects and for performing IVIVE to calculate Vmax from measure *in-vitro* intrinsic clearance.
